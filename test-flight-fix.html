<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wum-flight ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            background: #00ff88;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background: #00cc6f;
            transform: translateY(-2px);
        }
        .log-output {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            color: #00ff88;
            margin-top: 10px;
        }
        .log-line {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœˆï¸ wum-flight ä¿®å¾©æ¸¬è©¦</h1>
        
        <div class="test-section">
            <h3>ğŸ¯ æ¸¬è©¦ä¿®æ”¹å¾Œçš„æ•´åˆ</h3>
            <p>é€™å€‹æ¸¬è©¦é é¢æ¨¡æ“¬ piStoryReady äº‹ä»¶ï¼Œæ¸¬è©¦ wum-flight æ˜¯å¦èƒ½æ­£ç¢ºè®€å– Firebase ä¸¦ç”Ÿæˆç¥¨åˆ¸ã€‚</p>
            
            <button onclick="testStoryEvent()">ğŸ“– æ¨¡æ“¬æ•…äº‹äº‹ä»¶</button>
            <button onclick="testFlightAPI()">âœˆï¸ æ¸¬è©¦ Flight API</button>
            <button onclick="testFirebaseData()">ğŸ”¥ æ¸¬è©¦ Firebase è³‡æ–™</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
            
            <div id="logOutput" class="log-output">
                <div class="log-line">ç­‰å¾…æ¸¬è©¦...</div>
            </div>
        </div>
        
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <wum-flight id="wumFlight"></wum-flight>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥ wum-flight Web Component -->
    <script src="wum-flight.js"></script>
    
    <!-- è¼‰å…¥ Firebase æ¨¡æ“¬ -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js"></script>
    
    <script>
        let api = null;
        
        // ç­‰å¾… wum-flight å°±ç·’
        const wumFlight = document.getElementById('wum-flight');
        wumFlight.addEventListener('wum:ready', (e) => {
            api = e.detail.api;
            log('âœ… wum-flight å·²å°±ç·’');
        });
        
        wumFlight.addEventListener('wum:ticket-generated', (e) => {
            log('ğŸ« ç¥¨åˆ¸å·²ç”Ÿæˆ', e.detail.ticket);
            log(`ğŸ’° ç•¶å‰ Fuel: ${e.detail.currentFuel} / 120`);
        });
        
        // æ¨¡æ“¬ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyC5-AKkFhx9olWx57bdB985IwZA9DpH66o",
            authDomain: "subjective-clock.firebaseapp.com",
            projectId: "subjective-clock"
        };
        
        // åˆå§‹åŒ– Firebaseï¼ˆåƒ…ç”¨æ–¼æ¸¬è©¦ï¼‰
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            window.db = db;
            log('âœ… Firebase åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            log('âš ï¸ Firebase åˆå§‹åŒ–å¤±æ•—ï¼ˆæ¸¬è©¦æ¨¡å¼ï¼‰:', error.message);
        }
        
        // æ¨¡æ“¬ piStoryReady äº‹ä»¶
        function testStoryEvent() {
            log('ğŸ“– æ¨¡æ“¬ piStoryReady äº‹ä»¶...');
            
            // æ¨¡æ“¬æ•…äº‹è³‡æ–™
            const mockStoryData = {
                city: 'GRAHAMSTOWN',
                country: 'South Africa',
                countryCode: 'za',
                latitude: -33.30422,
                longitude: 26.53276,
                greeting: 'Molo!',
                language: 'ç§‘è–©èª',
                story: 'å—éæ—©å®‰ï¼ä»Šå¤©çš„ä½ åœ¨å—éçš„æ ¼é›·å§†æ–¯æ•¦é†’ä¾†ã€‚èµ°åœ¨é€™å€‹å……æ»¿æ­·å²æ•…äº‹çš„åŸå¸‚è£¡ï¼Œä½ å°‡æœƒç™¼ç¾ä¸€å€‹ç¥ç¥•çš„å‚³èªªï¼Œé—œæ–¼ä¸€ä½å®ˆè­·åŸå¸‚çš„ç¥ç§˜å®ˆè­·è€…ï¼Œåªæœ‰ç•¶åœ°äººæ‰çŸ¥é“çš„ç¥å¥‡æ•…äº‹ã€‚',
                fullContent: 'Molo!ã€‚å—éæ—©å®‰ï¼ä»Šå¤©çš„ä½ åœ¨å—éçš„æ ¼é›·å§†æ–¯æ•¦é†’ä¾†ã€‚èµ°åœ¨é€™å€‹å……æ»¿æ­·å²æ•…äº‹çš„åŸå¸‚è£¡ï¼Œä½ å°‡æœƒç™¼ç¾ä¸€å€‹ç¥ç¥•çš„å‚³èªªï¼Œé—œæ–¼ä¸€ä½å®ˆè­·åŸå¸‚çš„ç¥ç§˜å®ˆè­·è€…ï¼Œåªæœ‰ç•¶åœ°äººæ‰çŸ¥é“çš„ç¥å¥‡æ•…äº‹ã€‚',
                localTime: '4:51:59 AM'
            };
            
            // æ¨¡æ“¬ latestRecordï¼ˆå¾ Firebase æŸ¥è©¢åˆ°çš„è³‡æ–™ï¼‰
            const mockLatestRecord = {
                id: 'test-record-id',
                localTime: '4:51:59 AM',
                timestamp: new Date()
            };
            
            log('ğŸ“Š æ¨¡æ“¬è³‡æ–™:', mockStoryData);
            
            // æ¨¡æ“¬ updateResultData èª¿ç”¨å¾Œçš„ Flight è§¸ç™¼é‚è¼¯
            setTimeout(() => {
                if (window.wumFlightAPI) {
                    log('âœˆï¸ [wum-flight] æ•…äº‹å®Œæˆå¾Œç”Ÿæˆç¥¨åˆ¸...');
                    
                    // å–å¾—ç•¶å‰æ™‚é–“ï¼ˆHHMM æ ¼å¼ï¼‰
                    const now = new Date();
                    const currHHMM = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
                    
                    // å¾ Firebase æŸ¥è©¢ä¸Šä¸€æ¬¡è¨˜éŒ„çš„æ™‚é–“
                    let prevHHMM = null;
                    if (mockLatestRecord && mockLatestRecord.localTime) {
                        // æ¨™æº–åŒ–æ™‚é–“æ ¼å¼
                        prevHHMM = mockLatestRecord.localTime;
                        log('âœˆï¸ [wum-flight] å¾ Firebase æ‰¾åˆ°ä¸Šæ¬¡æ™‚é–“:', prevHHMM);
                    } else {
                        log('âœˆï¸ [wum-flight] æ²’æœ‰æ‰¾åˆ°ä¸Šæ¬¡æ™‚é–“ï¼Œå°‡ç”Ÿæˆé¦–æ¬¡ç¥¨åˆ¸');
                    }
                    
                    // åˆ¤æ–·æ˜¯å¦å¤œé–“
                    const hours = now.getHours();
                    const isNight = hours < 6 || hours >= 23;
                    
                    // ç”Ÿæˆç¥¨åˆ¸
                    const ticket = window.wumFlightAPI.generate({
                        currHHMM: currHHMM,
                        prevHHMM: prevHHMM,
                        nightPenalty: isNight,
                        streakBonus: false,
                        firstDayFree: false
                    });
                    
                    if (ticket) {
                        log('âœˆï¸ [wum-flight] ç¥¨åˆ¸ç”ŸæˆæˆåŠŸ:', ticket);
                        log('ğŸ’° [wum-flight] ç•¶å‰ Fuel:', window.wumFlightAPI.getFuel());
                    }
                } else {
                    log('â„¹ï¸ [wum-flight] API å°šæœªå°±ç·’ï¼Œç­‰å¾…å°±ç·’äº‹ä»¶...');
                    
                    // ç­‰å¾… wum-flight å°±ç·’äº‹ä»¶
                    const handleWumFlightReady = (e) => {
                        log('âœˆï¸ [wum-flight] å»¶é²å°±ç·’ï¼Œé–‹å§‹ç”Ÿæˆç¥¨åˆ¸...');
                        
                        const now = new Date();
                        const currHHMM = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
                        
                        let prevHHMM = null;
                        if (mockLatestRecord && mockLatestRecord.localTime) {
                            prevHHMM = mockLatestRecord.localTime;
                        }
                        
                        const hours = now.getHours();
                        const isNight = hours < 6 || hours >= 23;
                        
                        const ticket = e.detail.api.generate({
                            currHHMM: currHHMM,
                            prevHHMM: prevHHMM,
                            nightPenalty: isNight,
                            streakBonus: false,
                            firstDayFree: false
                        });
                        
                        if (ticket) {
                            log('âœˆï¸ [wum-flight] å»¶é²ç”ŸæˆæˆåŠŸ:', ticket);
                        }
                        
                        // ç§»é™¤äº‹ä»¶ç›£è½å™¨
                        window.removeEventListener('wumFlightReady', handleWumFlightReady);
                    };
                    
                    window.addEventListener('wumFlightReady', handleWumFlightReady);
                }
            }, 2000); // å»¶é² 2 ç§’ç¢ºä¿ UI æ›´æ–°å®Œæˆ
            
            log('âœ… piStoryReady äº‹ä»¶æ¨¡æ“¬å®Œæˆ');
        }
        
        function testFlightAPI() {
            log('âœˆï¸ æ¸¬è©¦ Flight API...');
            
            if (api) {
                log('API ç‹€æ…‹:', {
                    getFuel: typeof api.getFuel,
                    generate: typeof api.generate,
                    getTickets: typeof api.getTickets,
                    getCurrentTicket: typeof api.getCurrentTicket
                });
                
                log('ç•¶å‰ Fuel:', api.getFuel());
                log('æ­·å²ç¥¨åˆ¸:', api.getTickets());
                log('ç•¶å‰ç¥¨åˆ¸:', api.getCurrentTicket());
            } else {
                log('âŒ API å°šæœªå°±ç·’');
            }
        }
        
        function testFirebaseData() {
            log('ğŸ”¥ æ¸¬è©¦ Firebase è³‡æ–™...');
            
            if (window.db) {
                log('âœ… Firebase å·²åˆå§‹åŒ–');
                log('è³‡æ–™åº«é¡å‹:', typeof window.db);
            } else {
                log('âŒ Firebase æœªåˆå§‹åŒ–');
            }
        }
        
        function log(message, data) {
            const logDiv = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = document.createElement('div');
            logLine.className = 'log-line';
            
            if (data) {
                logLine.textContent = `[${timestamp}] ${message}: ${JSON.stringify(data, null, 2)}`;
            } else {
                logLine.textContent = `[${timestamp}] ${message}`;
            }
            
            logDiv.insertBefore(logLine, logDiv.firstChild);
            
            // é™åˆ¶æ—¥èªŒæ•¸é‡
            while (logDiv.children.length > 50) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '<div class="log-line">æ—¥èªŒå·²æ¸…é™¤</div>';
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ æ¸¬è©¦é é¢å·²è¼‰å…¥');
            log('ç­‰å¾… wum-flight å°±ç·’...');
        });
    </script>
</body>
</html>
